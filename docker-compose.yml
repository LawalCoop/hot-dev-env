# HOTOSM Development Environment
# Orchestrates Portal, Drone-TM, fAIr, OAM, and shared services using subdomain routing

name: hotosm-dev

networks:
  hotosm:
    name: hotosm-dev
    driver: bridge

volumes:
  portal-db-data:
  login-hanko-db-data:
  dronetm-db-data:
  chatmap-db-data:
  chatmap-sessions:
  dronetm-minio-data:
  dronetm-redis-data:
  oam-db-data:
  fair-db-data:
  fair-redis-data:
  umap-db-data:
  export-tool-db-data:
  export-tool-downloads:

services:
  # ==========================================
  # Traefik - Reverse Proxy (Path-based Routing)
  # ==========================================
  traefik:
    image: traefik:v2.11
    container_name: hotosm-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--log.level=INFO"
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/traefik/certs:ro
      - ./traefik-tls.yml:/etc/traefik/dynamic/tls.yml:ro
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`localhost`,`127.0.0.1`) && PathPrefix(`/traefik`)"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  # ==========================================
  # Portal - Authentication & SSO Portal
  # ==========================================

  # Portal Frontend (React + Vite)
  portal-frontend:
    platform: linux/amd64  # Required for Mac M1/M2/M3 compatibility
    build:
      context: ../portal/frontend
      dockerfile: Dockerfile
      target: development
    container_name: hotosm-portal-frontend
    volumes:
      - ../portal/frontend:/app
      - /app/node_modules
      - ../login/auth-libs/web-component:/auth-libs-src  # For local auth-libs development
    environment:
      - VITE_HANKO_URL=https://login.hotosm.test
      - VITE_API_URL=https://portal.hotosm.test/api
      - VITE_DRONE_TM_FRONTEND_URL=https://dronetm.hotosm.test
      # Note: API routing handled by Traefik, not Vite proxy
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portal-frontend.rule=Host(`portal.hotosm.test`)"
      - "traefik.http.routers.portal-frontend.entrypoints=websecure"
      - "traefik.http.routers.portal-frontend.tls=true"
      - "traefik.http.services.portal-frontend.loadbalancer.server.port=5173"
    depends_on:
      - portal-backend

  # Portal Backend (FastAPI)
  portal-backend:
    build:
      context: ../portal
      dockerfile: backend/Dockerfile
      target: development
      args:
        - BUILDKIT_INLINE_CACHE=1
    container_name: hotosm-portal-backend
    volumes:
      - ../portal/backend:/app
      - /app/.venv
    environment:
      - DATABASE_URL=postgresql+asyncpg://portal:portal@portal-db:5432/portal
      - HANKO_API_URL=http://hanko:8000
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - COOKIE_DOMAIN=.hotosm.test
      - COOKIE_SECURE=true
      - COOKIE_SAMESITE=none
      - OSM_CLIENT_ID=${OSM_CLIENT_ID}
      - OSM_CLIENT_SECRET=${OSM_CLIENT_SECRET}
      - FRONTEND_URL=https://portal.hotosm.test
      - BACKEND_CORS_ORIGINS=["https://portal.hotosm.test","https://login.hotosm.test","https://dronetm.hotosm.test"]
      - ADMIN_EMAILS=${ADMIN_EMAILS:-admin@hotosm.org}
      - DRONE_TM_BACKEND_URL=https://dronetm.hotosm.test/api
      - FAIR_API_BASE_URL=https://fair.hotosm.test/api/v1
    extra_hosts:
      - "dronetm.hotosm.test:host-gateway"
      - "fair.hotosm.test:host-gateway"
      - "login.hotosm.test:host-gateway"
    command: sh -c "uv run alembic upgrade head && uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portal-backend.rule=Host(`portal.hotosm.test`) && PathPrefix(`/api`)"
      - "traefik.http.routers.portal-backend.entrypoints=websecure"
      - "traefik.http.routers.portal-backend.tls=true"
      - "traefik.http.services.portal-backend.loadbalancer.server.port=8000"
    depends_on:
      - portal-db
      - hanko

  # Portal Database
  portal-db:
    image: postgis/postgis:16-3.4
    container_name: hotosm-portal-db
    environment:
      - POSTGRES_USER=portal
      - POSTGRES_PASSWORD=portal
      - POSTGRES_DB=portal
    volumes:
      - portal-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U portal"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Login - Authentication & SSO Service
  # ==========================================

  # Login Frontend (React + Vite) - Custom login page
  login-frontend:
    build:
      context: ../login/frontend
      dockerfile: Dockerfile
      target: dev
    container_name: hotosm-login-frontend
    volumes:
      - ../login/frontend/src:/app/src
      - ../login/frontend/public:/app/public
      - ../login/frontend/vite.config.ts:/app/vite.config.ts
      - ../login/auth-libs/web-component:/auth-libs-src  # For local auth-libs development
    environment:
      - VITE_HANKO_URL=https://login.hotosm.test
      - VITE_BACKEND_URL=https://login.hotosm.test/api
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      # Route /app to login frontend (matches production K8s config)
      - "traefik.http.routers.login-frontend.rule=Host(`login.hotosm.test`) && PathPrefix(`/app`)"
      - "traefik.http.routers.login-frontend.entrypoints=websecure"
      - "traefik.http.routers.login-frontend.tls=true"
      - "traefik.http.routers.login-frontend.priority=1"
      - "traefik.http.services.login-frontend.loadbalancer.server.port=5174"
    depends_on:
      - login-backend

  # Login Backend (FastAPI) - Custom auth logic
  login-backend:
    build:
      context: ../login/backend
      dockerfile: Dockerfile
      target: dev
      args:
        - BUILDKIT_INLINE_CACHE=1
    container_name: hotosm-login-backend
    volumes:
      - ../login/backend/app:/app/app
      - ../login/backend/.env:/app/.env
      - /app/.venv
    environment:
      - HANKO_API_URL=http://hanko:8000
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      # COOKIE_DOMAIN not set - let browser handle it (works with both localhost and 127.0.0.1)
      - OSM_CLIENT_ID=${OSM_CLIENT_ID}
      - OSM_CLIENT_SECRET=${OSM_CLIENT_SECRET}
      - OSM_REDIRECT_URI=https://login.hotosm.test/api/auth/osm/callback
      - ADMIN_EMAILS=hernangigena@gmail.com,justina@animus.com.ar,andreatchirillano@hotmail.com,emilio.mariscal@hotosm.org
      # App URLs for admin proxy
      - PORTAL_BACKEND_URL=http://portal-backend:8000
      - DRONETM_BACKEND_URL=http://dronetm-backend:8000
      - FAIR_BACKEND_URL=http://fair-backend:8000
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      # Route /me endpoint to login-backend
      - "traefik.http.routers.login-backend-me.rule=Host(`login.hotosm.test`) && Path(`/me`)"
      - "traefik.http.routers.login-backend-me.entrypoints=websecure"
      - "traefik.http.routers.login-backend-me.tls=true"
      - "traefik.http.routers.login-backend-me.priority=20"
      - "traefik.http.routers.login-backend-me.service=login-backend"
      # Route /api endpoints to login-backend
      - "traefik.http.routers.login-backend.rule=Host(`login.hotosm.test`) && PathPrefix(`/api`)"
      - "traefik.http.routers.login-backend.entrypoints=websecure"
      - "traefik.http.routers.login-backend.tls=true"
      - "traefik.http.routers.login-backend.priority=15"
      - "traefik.http.services.login-backend.loadbalancer.server.port=8000"
    depends_on:
      - hanko
      - hanko-db

  # ==========================================
  # Hanko - Core Authentication Service (from login repo)
  # ==========================================

  # Hanko database migrations (runs once before Hanko starts)
  hanko-migrate:
    platform: linux/amd64  # No ARM64 image available
    image: ghcr.io/teamhanko/hanko:latest
    container_name: hotosm-hanko-migrate
    volumes:
      - ./config/hanko-config.yaml:/etc/config/.config.yaml:ro
    command: migrate up --config /etc/config/.config.yaml
    environment:
      - DATABASE_URL=postgres://hanko:hanko@hanko-db:5432/hanko?sslmode=disable
    depends_on:
      hanko-db:
        condition: service_healthy
    networks:
      - hotosm
    restart: "no"

  hanko:
    platform: linux/amd64  # No ARM64 image available
    image: ghcr.io/teamhanko/hanko:latest
    container_name: hotosm-hanko
    volumes:
      - ./config/hanko-config.yaml:/etc/config/.config.yaml:ro
    command: serve --config /etc/config/.config.yaml public
    environment:
      - DATABASE_URL=postgres://hanko:hanko@hanko-db:5432/hanko?sslmode=disable
      - SESSION_COOKIE_DOMAIN=.hotosm.test
      - SESSION_COOKIE_HTTP_ONLY=true
      - SESSION_COOKIE_SAME_SITE=lax
      - SESSION_COOKIE_SECURE=false
      - THIRD_PARTY_COOKIE_DOMAIN=.hotosm.test
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      # Hanko API endpoints with higher priority than login-frontend
      - "traefik.http.routers.hanko-wellknown.rule=Host(`login.hotosm.test`) && PathPrefix(`/.well-known`)"
      - "traefik.http.routers.hanko-wellknown.entrypoints=websecure"
      - "traefik.http.routers.hanko-wellknown.tls=true"
      - "traefik.http.routers.hanko-wellknown.priority=50"
      - "traefik.http.routers.hanko-wellknown.service=hanko"
      - "traefik.http.routers.hanko-api.rule=Host(`login.hotosm.test`) && (PathPrefix(`/registration`) || PathPrefix(`/logout`) || PathPrefix(`/sessions`) || PathPrefix(`/users`) || PathPrefix(`/passcode`) || PathPrefix(`/webauthn`) || PathPrefix(`/token`) || PathPrefix(`/thirdparty`) || PathPrefix(`/profile`) || PathPrefix(`/emails`) || PathPrefix(`/password`) || PathPrefix(`/me`) || PathPrefix(`/flow`))"
      - "traefik.http.routers.hanko-api.entrypoints=websecure"
      - "traefik.http.routers.hanko-api.tls=true"
      - "traefik.http.routers.hanko-api.priority=10"
      - "traefik.http.routers.hanko-api.service=hanko"
      # Hanko /login endpoint for POST requests (API)
      - "traefik.http.routers.hanko-login.rule=Host(`login.hotosm.test`) && Path(`/login`) && Method(`POST`,`PUT`,`DELETE`,`PATCH`)"
      - "traefik.http.routers.hanko-login.entrypoints=websecure"
      - "traefik.http.routers.hanko-login.tls=true"
      - "traefik.http.routers.hanko-login.priority=5"
      - "traefik.http.routers.hanko-login.service=hanko"
      - "traefik.http.services.hanko.loadbalancer.server.port=8000"
    depends_on:
      hanko-db:
        condition: service_healthy
      hanko-migrate:
        condition: service_completed_successfully

  hanko-db:
    image: postgres:16-alpine
    container_name: hotosm-hanko-db
    environment:
      - POSTGRES_USER=hanko
      - POSTGRES_PASSWORD=hanko
      - POSTGRES_DB=hanko
    volumes:
      - login-hanko-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hanko"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Mailhog - Email catcher for development (captures all emails without sending)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: hotosm-mailhog
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mail.rule=Host(`mail.hotosm.test`)"
      - "traefik.http.routers.mail.entrypoints=websecure"
      - "traefik.http.routers.mail.tls=true"
      - "traefik.http.services.mail.loadbalancer.server.port=8025"

  # ==========================================
  # Drone-TM - Drone Tasking Manager
  # ==========================================

  # Drone-TM Frontend (React + Vite)
  dronetm-frontend:
    build:
      context: ../drone-tm/src/frontend
      dockerfile: Dockerfile
      target: development
    container_name: hotosm-dronetm-frontend
    volumes:
      - ../drone-tm/src/frontend/src:/app/src
      - ../drone-tm/src/frontend/public:/app/public
      - ../drone-tm/src/frontend/vite.config.ts:/app/vite.config.ts
      - ../drone-tm/src/frontend/index.html:/app/index.html
      - ../drone-tm/src/frontend/components.json:/app/components.json
      - ../drone-tm/src/frontend/postcss.config.js:/app/postcss.config.js
      - ../drone-tm/src/frontend/tailwind.config.js:/app/tailwind.config.js
      - ../login/auth-libs/web-component:/auth-libs-src  # For local auth-libs development
    environment:
      - VITE_AUTH_PROVIDER=${AUTH_PROVIDER:-hanko}
      - VITE_HANKO_URL=https://login.hotosm.test
      - VITE_FRONTEND_URL=https://dronetm.hotosm.test
      - VITE_API_URL=https://dronetm.hotosm.test/api
      # Legacy env vars (for compatibility with existing code)
      - API_URL_V1=https://dronetm.hotosm.test/api
      - BASE_URL=https://dronetm.hotosm.test/api
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dronetm-frontend.rule=Host(`dronetm.hotosm.test`)"
      - "traefik.http.routers.dronetm-frontend.entrypoints=websecure"
      - "traefik.http.routers.dronetm-frontend.tls=true"
      - "traefik.http.services.dronetm-frontend.loadbalancer.server.port=3040"
    depends_on:
      - dronetm-backend

  # Drone-TM Backend (FastAPI)
  dronetm-backend:
    build:
      context: ../drone-tm/src/backend
      dockerfile: Dockerfile
      target: service
    container_name: hotosm-dronetm-backend
    volumes:
      - ../drone-tm/src/backend/app:/project/src/backend/app
    environment:
      - DATABASE_URL=postgresql+asyncpg://dtm:dtm@dronetm-db:5432/dtm_db
      - POSTGRES_HOST=dronetm-db
      - AUTH_PROVIDER=${AUTH_PROVIDER:-hanko}
      - HANKO_API_URL=http://hanko:8000
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - BACKEND_URL=https://dronetm.hotosm.test
      - FRONTEND_URL=https://dronetm.hotosm.test
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=dtm_user
      - S3_SECRET_KEY=somelongpassword
      - S3_BUCKET_NAME=dtm-bucket
      - S3_DOWNLOAD_ROOT=https://s3.hotosm.test
      - REDIS_URL=redis://redis:6379
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - ADMIN_EMAILS=hernangigena@gmail.com,justina@animus.com.ar,andreatchirillano@hotmail.com,emilio.mariscal@hotosm.org
      - EXTRA_CORS_ORIGINS=https://dronetm.hotosm.test,https://login.hotosm.test
    command: >
      sh -c "alembic upgrade heads &&
             uvicorn app.main:api --host 0.0.0.0 --port 8000 --log-level info --reload"
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      # Main dronetm backend router (from dronetm.hotosm.test)
      - "traefik.http.routers.dronetm-backend.rule=Host(`dronetm.hotosm.test`) && PathPrefix(`/api`)"
      - "traefik.http.routers.dronetm-backend.entrypoints=websecure"
      - "traefik.http.routers.dronetm-backend.tls=true"
      - "traefik.http.routers.dronetm-backend.middlewares=dronetm-strip-api"
      # Middleware to strip /api prefix before forwarding to backend
      - "traefik.http.middlewares.dronetm-strip-api.stripprefix.prefixes=/api"
      # Note: Portal integration routes (/api/drone-tasking-manager/*) are handled by portal-backend
      # which proxies to drone-tm with proper URL translation (e.g., /projects/user -> /projects/?filter_by_owner=true)
      # Service configuration
      - "traefik.http.services.dronetm-backend.loadbalancer.server.port=8000"
    depends_on:
      - dronetm-db
      - minio
      - redis

  # Drone-TM Database
  dronetm-db:
    image: postgis/postgis:16-3.4-alpine
    container_name: hotosm-dronetm-db
    environment:
      - POSTGRES_USER=dtm
      - POSTGRES_PASSWORD=dtm
      - POSTGRES_DB=dtm_db
    volumes:
      - dronetm-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dtm -d dtm_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO - S3-compatible storage for drone imagery
  minio:
    image: minio/minio:latest
    container_name: hotosm-minio
    command: server /data --console-address ":9090"
    environment:
      - MINIO_ROOT_USER=dtm_user
      - MINIO_ROOT_PASSWORD=somelongpassword
    volumes:
      - dronetm-minio-data:/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=true"
      # MinIO Console (Web UI)
      - "traefik.http.routers.minio-console.rule=Host(`minio.hotosm.test`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls=true"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9090"
      # MinIO S3 API (for presigned URLs)
      - "traefik.http.routers.minio-api.rule=Host(`s3.hotosm.test`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls=true"
      - "traefik.http.routers.minio-api.service=minio-api"
      - "traefik.http.routers.minio-api.middlewares=minio-cors"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
      # CORS headers for S3 API
      - "traefik.http.middlewares.minio-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE,HEAD"
      - "traefik.http.middlewares.minio-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.minio-cors.headers.accesscontrolalloworiginlist=https://dronetm.hotosm.test,https://portal.hotosm.test,https://fair.hotosm.test"
      - "traefik.http.middlewares.minio-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.minio-cors.headers.addvaryheader=true"

  # MinIO Init - Creates buckets on startup
  minio-init:
    image: minio/mc:latest
    container_name: hotosm-minio-init
    depends_on:
      minio:
        condition: service_started
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set minio http://minio:9000 dtm_user somelongpassword;
      mc mb minio/dtm-bucket --ignore-existing;
      mc anonymous set download minio/dtm-bucket;
      echo 'Buckets created successfully';
      "
    networks:
      - hotosm

  # Redis - Cache and task queue
  redis:
    image: redis:7-alpine
    container_name: hotosm-redis
    volumes:
      - dronetm-redis-data:/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NodeODM - Imagery processing
  nodeodm:
    image: opendronemap/nodeodm:latest
    container_name: hotosm-nodeodm
    environment:
      - NODE_OPTIONS=--max-old-space-size=8192
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nodeodm.rule=Host(`nodeodm.localhost`)"
      - "traefik.http.services.nodeodm.loadbalancer.server.port=3000"

  # ==========================================
  # OpenAerialMap - Imagery Catalog & Browser
  # ==========================================

  # OAM Frontend (React + Vite)
  oam-frontend:
    build:
      context: ../openaerialmap/frontend
      dockerfile: Dockerfile
      target: development
    container_name: hotosm-oam-frontend
    volumes:
      - ../openaerialmap/frontend:/app
      - /app/node_modules
      - ../login/auth-libs/web-component:/auth-libs-src  # For local auth-libs development
    environment:
      - VITE_HANKO_URL=https://login.hotosm.test
      - VITE_API_URL=https://openaerialmap.hotosm.test/api
      - VITE_STAC_API_URL=https://openaerialmap.hotosm.test
      - VITE_STAC_API_PATHNAME=api
      - VITE_STAC_TILER_PATHNAME=api/raster
      - VITE_STAC_ITEMS_LIMIT=40
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.oam-frontend.rule=Host(`openaerialmap.hotosm.test`)"
      - "traefik.http.routers.oam-frontend.entrypoints=websecure"
      - "traefik.http.routers.oam-frontend.tls=true"
      - "traefik.http.routers.oam-frontend.priority=1"
      - "traefik.http.services.oam-frontend.loadbalancer.server.port=9000"
    depends_on:
      - oam-backend

  # OAM Backend (FastAPI STAC API)
  oam-backend:
    build:
      context: ../openaerialmap/backend/stac-api
      dockerfile: Dockerfile
    container_name: hotosm-oam-backend
    volumes:
      - ../openaerialmap/backend/stac-api:/app
      - /app/.venv
    environment:
      # Database configuration (stac-fastapi-pgstac format)
      - POSTGRES_USER=postgres
      - POSTGRES_PASS=postgres
      - POSTGRES_DBNAME=postgres
      - POSTGRES_HOST_READER=oam-db
      - POSTGRES_HOST_WRITER=oam-db
      - POSTGRES_PORT=5432
      # FastAPI configuration
      - ROOT_PATH=/api
      # Auth configuration
      - HANKO_API_URL=http://hanko:8000
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - COOKIE_DOMAIN=.hotosm.test
      - COOKIE_SECURE=true
      - COOKIE_SAMESITE=none
      - OSM_CLIENT_ID=${OSM_CLIENT_ID}
      - OSM_CLIENT_SECRET=${OSM_CLIENT_SECRET}
      - AUTH_PROVIDER=${AUTH_PROVIDER:-hanko}
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.oam-backend.rule=Host(`openaerialmap.hotosm.test`) && PathPrefix(`/api`)"
      - "traefik.http.routers.oam-backend.entrypoints=websecure"
      - "traefik.http.routers.oam-backend.tls=true"
      - "traefik.http.routers.oam-backend.priority=10"
      - "traefik.http.services.oam-backend.loadbalancer.server.port=8080"
    depends_on:
      oam-db:
        condition: service_healthy

  # OAM Database (PostgreSQL + pgSTAC)
  oam-db:
    platform: linux/amd64  # No ARM64 image available
    image: ghcr.io/stac-utils/pgstac:v0.9.3
    container_name: hotosm-oam-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    volumes:
      - oam-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # fAIr - AI Assisted Mapping
  # ==========================================

  # fAIr Frontend (React + Vite)
  fair-frontend:
    build:
      context: ../fAIr/frontend
      dockerfile: Dockerfile.dev
    container_name: hotosm-fair-frontend
    volumes:
      - ../fAIr/frontend/src:/app/src
      - ../fAIr/frontend/public:/app/public
      - ../fAIr/frontend/index.html:/app/index.html
      - ../fAIr/frontend/package.json:/app/package.json
      - ../fAIr/frontend/pnpm-lock.yaml:/app/pnpm-lock.yaml
      - ../fAIr/frontend/tsconfig.json:/app/tsconfig.json
      - ../fAIr/frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ../fAIr/frontend/vite.config.mts:/app/vite.config.mts
      - ../login/auth-libs/web-component:/auth-libs-src  # For local auth-libs development
    environment:
      - VITE_AUTH_PROVIDER=${AUTH_PROVIDER:-hanko}
      - VITE_HANKO_URL=https://login.hotosm.test
      - VITE_BASE_API_URL=https://fair.hotosm.test/api/v1/
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.fair-frontend.rule=Host(`fair.hotosm.test`)"
      - "traefik.http.routers.fair-frontend.entrypoints=websecure"
      - "traefik.http.routers.fair-frontend.tls=true"
      - "traefik.http.services.fair-frontend.loadbalancer.server.port=3000"
    depends_on:
      - fair-backend

  # fAIr Backend (Django)
  fair-backend:
    build:
      context: ../fAIr/backend
      dockerfile: Dockerfile.API
    container_name: hotosm-fair-backend
    volumes:
      - ../fAIr/backend:/app
      - /app/.venv  # Preserve .venv from build
    environment:
      - DATABASE_URL=postgis://fair:fair@fair-db:5432/fair
      - AUTH_PROVIDER=${AUTH_PROVIDER:-hanko}
      - HANKO_API_URL=http://hanko:8000
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - COOKIE_DOMAIN=.hotosm.test
      - OSM_CLIENT_ID=${OSM_CLIENT_ID}
      - OSM_CLIENT_SECRET=${OSM_CLIENT_SECRET}
      - OSM_LOGIN_REDIRECT_URI=https://fair.hotosm.test/authenticate
      - OSM_REDIRECT_URI=https://fair.hotosm.test/api/v1/auth/osm/callback/
      - REDIS_URL=redis://fair-redis:6379
      - CELERY_BROKER_URL=redis://fair-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://fair-redis:6379/0
      - DEBUG=True
      - ALLOWED_HOSTS=fair.hotosm.test,localhost,fair-backend
      - CORS_ALLOWED_ORIGINS=https://fair.hotosm.test,https://login.hotosm.test
      - FRONTEND_URL=https://fair.hotosm.test
      - LOGIN_URL=https://login.hotosm.test
      - ADMIN_EMAILS=hernangigena@gmail.com,justina@animus.com.ar,andreatchirillano@hotmail.com,emilio.mariscal@hotosm.org
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py runserver 0.0.0.0:8000"
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.fair-backend.rule=Host(`fair.hotosm.test`) && PathPrefix(`/api`)"
      - "traefik.http.routers.fair-backend.entrypoints=websecure"
      - "traefik.http.routers.fair-backend.tls=true"
      - "traefik.http.services.fair-backend.loadbalancer.server.port=8000"
    depends_on:
      fair-db:
        condition: service_healthy
      fair-redis:
        condition: service_healthy

  # fAIr Database (PostgreSQL + PostGIS)
  fair-db:
    image: postgis/postgis:16-3.4
    container_name: hotosm-fair-db
    environment:
      - POSTGRES_USER=fair
      - POSTGRES_PASSWORD=fair
      - POSTGRES_DB=fair
    volumes:
      - fair-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fair"]
      interval: 10s
      timeout: 5s
      retries: 5

  # fAIr Redis (for Celery/Django-Q)
  fair-redis:
    image: redis:7-alpine
    container_name: hotosm-fair-redis
    volumes:
      - fair-redis-data:/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # uMap - User Map Editor
  # ==========================================

  # uMap Database (PostGIS)
  umap-db:
    platform: linux/amd64  # No ARM64 image available
    image: postgis/postgis:14-3.5-alpine
    container_name: hotosm-umap-db
    environment:
      - POSTGRES_DB=umap
      - POSTGRES_USER=umap
      - POSTGRES_PASSWORD=umap123456
    volumes:
      - umap-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U umap"]
      interval: 10s
      timeout: 5s
      retries: 5

  # uMap Application (Django)
  umap-app:
    build:
      context: ../umap/app
      dockerfile: Dockerfile
    container_name: hotosm-umap-app
    volumes:
      - ../umap/app:/app
      - /app/.venv  # Preserve .venv from build
      - ./certs/localhost.crt:/etc/ssl/certs/localhost.crt:ro
    environment:
      - UMAP_SITE_URL=https://umap.hotosm.test
      - UMAP_SETTINGS=/app/settings.py
      - UMAP_SECRET_KEY=${UMAP_SECRET_KEY:-change-me-in-production-min-32-chars}
      - UMAP_DB_HOST=umap-db
      - UMAP_DB_NAME=umap
      - UMAP_DB_USER=umap
      - UMAP_DB_PASSWORD=umap123456
      - PGPASSWORD=umap123456
      - DEBUG=${DEBUG:-true}
      - ALLOWED_HOSTS=umap.hotosm.test,localhost,127.0.0.1,umap-app
      - CSRF_TRUSTED_ORIGINS=https://umap.hotosm.test
      - AUTH_PROVIDER=hanko
      # Backend uses internal HTTP URL (no SSL issues)
      - HANKO_API_URL=http://hanko:8000
      # Frontend uses public HTTPS URL (for web component)
      - HANKO_PUBLIC_URL=https://login.hotosm.test
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - COOKIE_DOMAIN=.hotosm.test
      - COOKIE_SECURE=false
      - ADMIN_EMAILS=hernangigena@gmail.com,justina@animus.com.ar,andreatchirillano@hotmail.com,emilio.mariscal@hotosm.org
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.umap-app.rule=Host(`umap.hotosm.test`)"
      - "traefik.http.routers.umap-app.entrypoints=websecure"
      - "traefik.http.routers.umap-app.tls=true"
      - "traefik.http.services.umap-app.loadbalancer.server.port=8000"
    depends_on:
      umap-db:
        condition: service_healthy

  # ==========================================
  # ChatMap - Chat to Map Converter
  # ==========================================

  # ChatMap Frontend (React + Vite)
  chatmap-frontend:
    build:
      context: ../chatmap/chatmap-ui
      dockerfile: Dockerfile
    container_name: hotosm-chatmap-frontend
    volumes:
      - ../chatmap/chatmap-ui/src:/app/src
      - ../chatmap/chatmap-ui/public:/app/public
      - ./config/chatmap-config.json:/app/public/config.json:ro
      - ../chatmap/chatmap-ui/index.html:/app/index.html
      - ../chatmap/chatmap-ui/vite.config.js:/app/vite.config.js
      # Note: @hotosm/hanko-auth is now installed from npm
    environment:
      - VITE_HANKO_URL=https://login.hotosm.test
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.chatmap-frontend.rule=Host(`chatmap.hotosm.test`)"
      - "traefik.http.routers.chatmap-frontend.entrypoints=websecure"
      - "traefik.http.routers.chatmap-frontend.tls=true"
      - "traefik.http.services.chatmap-frontend.loadbalancer.server.port=5173"

  # ChatMap Backend (FastAPI)
  chatmap-backend:
    build:
      context: ../chatmap/chatmap-api
      dockerfile: Dockerfile
      target: development
    container_name: hotosm-chatmap-backend
    volumes:
      - ../chatmap/chatmap-api:/app
    environment:
      - CHATMAP_API_DEBUG=true
      - CHATMAP_API_URL=https://chatmap.hotosm.test/api
      - CHATMAP_DB_HOST=chatmap-db
      - CHATMAP_DB_USER=chatmap
      - CHATMAP_DB_PASSWORD=chatmap
      - CHATMAP_DB=chatmap
      - HANKO_API_URL=http://hanko:8000
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - REDIS_HOST=redis
      - SERVER_URL=http://chatmap-go:8001
      - CHATMAP_ENC_KEY=${CHATMAP_ENC_KEY:-0123456789ABCDEF0123456789ABCDEF}
    networks:
      - hotosm
    depends_on:
      chatmap-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      chatmap-go:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.chatmap-backend.rule=Host(`chatmap.hotosm.test`) && PathPrefix(`/api`)"
      - "traefik.http.routers.chatmap-backend.entrypoints=websecure"
      - "traefik.http.routers.chatmap-backend.tls=true"
      - "traefik.http.middlewares.chatmap-strip-api.stripprefix.prefixes=/api"
      - "traefik.http.routers.chatmap-backend.middlewares=chatmap-strip-api"
      - "traefik.http.services.chatmap-backend.loadbalancer.server.port=8000"

  # ChatMap Database (PostgreSQL + PostGIS)
  chatmap-db:
    image: postgis/postgis:16-3.4-alpine
    container_name: hotosm-chatmap-db
    environment:
      - POSTGRES_USER=chatmap
      - POSTGRES_PASSWORD=chatmap
      - POSTGRES_DB=chatmap
    volumes:
      - chatmap-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatmap"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ChatMap Go Backend (WhatsApp connector)
  chatmap-go:
    image: golang:1.24
    container_name: hotosm-chatmap-go
    working_dir: /app
    command: sh -c "go mod download && go run main.go"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CHATMAP_ENC_KEY=${CHATMAP_ENC_KEY:-0123456789ABCDEF0123456789ABCDEF}
    volumes:
      - ../chatmap/chatmap-im-connector:/app
      - chatmap-sessions:/app/sessions
    networks:
      - hotosm
    depends_on:
      redis:
        condition: service_healthy

  # ==========================================
  # OSM Export Tool - OSM Data Export Service
  # ==========================================

  # Export Tool Database (PostgreSQL + PostGIS)
  export-tool-db:
    platform: linux/amd64  # Required for Mac M1/M2/M3 compatibility
    image: postgis/postgis:16-3.4-alpine
    container_name: hotosm-export-tool-db
    environment:
      - POSTGRES_USER=exports
      - POSTGRES_PASSWORD=exports
      - POSTGRES_DB=exports
    volumes:
      - export-tool-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U exports"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Export Tool Redis (for Dramatiq task queue)
  export-tool-redis:
    image: redis:7-alpine
    container_name: hotosm-export-tool-redis
    networks:
      - hotosm
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Export Tool Application (Django)
  export-tool-app:
    platform: linux/amd64  # Required for Mac M1/M2/M3 compatibility
    build:
      context: ../osm-export-tool
      dockerfile: Dockerfile
      target: development
    container_name: hotosm-export-tool-app
    volumes:
      - ../osm-export-tool:/app
      - export-tool-downloads:/app/export_downloads
      - ./config/export-tool-settings.py:/app/core/settings/docker.py:ro
    environment:
      - DATABASE_URL=postgis://exports:exports@export-tool-db:5432/exports
      - DEBUG=True
      - DJANGO_ENV=development
      - DJANGO_SETTINGS_MODULE=core.settings.docker
      - HOSTNAME=export-tool.hotosm.test
      - ALLOWED_HOSTS=export-tool.hotosm.test,localhost,127.0.0.1,export-tool-app
      - USE_X_FORWARDED_HOST=true
      - SECRET_KEY=dev-secret-key-change-in-production
      # Redis for Dramatiq
      - REDIS_HOST=export-tool-redis
      - REDIS_PORT=6379
      # OSM OAuth (same as other services)
      - OSM_CLIENT_ID=${OSM_CLIENT_ID}
      - OSM_CLIENT_SECRET=${OSM_CLIENT_SECRET}
      # Email (using mailhog)
      - EMAIL_HOST=mailhog
      - EMAIL_PORT=1025
      - EMAIL_USE_TLS=false
      # Overpass API
      - OVERPASS_API_URL=https://overpass-api.de/api/
      # Raw Data API
      - RAW_DATA_API_URL=https://api-stage.raw-data.hotosm.org/
      # HDX (required for settings to load, use dummy key for dev)
      - HDX_API_KEY=dev-hdx-api-key
      - HDX_SITE=demo
      - SYNC_TO_HDX=false
      # Hanko SSO Authentication
      - AUTH_PROVIDER=${AUTH_PROVIDER:-hanko}
      - HANKO_API_URL=http://hanko:8000
      - HANKO_PUBLIC_URL=https://login.hotosm.test
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - COOKIE_DOMAIN=.hotosm.test
      - COOKIE_SECURE=false
      - ADMIN_EMAILS=hernangigena@gmail.com,justina@animus.com.ar,andreatchirillano@hotmail.com,emilio.mariscal@hotosm.org
    command: >
      sh -c "
        cd /app/ui && (yarn install || true) && (yarn run dist || true) &&
        cd /app &&
        python3 manage.py migrate --noinput &&
        python3 manage.py collectstatic --noinput || true &&
        python3 manage.py runserver 0.0.0.0:8000
      "
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.export-tool-app.rule=Host(`export-tool.hotosm.test`)"
      - "traefik.http.routers.export-tool-app.entrypoints=websecure"
      - "traefik.http.routers.export-tool-app.tls=true"
      - "traefik.http.services.export-tool-app.loadbalancer.server.port=8000"
    depends_on:
      export-tool-db:
        condition: service_healthy
      export-tool-redis:
        condition: service_healthy
      mailhog:
        condition: service_started

  # Export Tool Worker (Dramatiq for background tasks)
  export-tool-worker:
    platform: linux/amd64  # Required for Mac M1/M2/M3 compatibility
    build:
      context: ../osm-export-tool
      dockerfile: Dockerfile
      target: development
    container_name: hotosm-export-tool-worker
    volumes:
      - ../osm-export-tool:/app
      - export-tool-downloads:/app/export_downloads
      - ./config/export-tool-settings.py:/app/core/settings/docker.py:ro
    environment:
      - DATABASE_URL=postgis://exports:exports@export-tool-db:5432/exports
      - DEBUG=True
      - DJANGO_ENV=development
      - DJANGO_SETTINGS_MODULE=core.settings.docker
      - HOSTNAME=export-tool.hotosm.test
      - SECRET_KEY=dev-secret-key-change-in-production
      # Redis for Dramatiq
      - REDIS_HOST=export-tool-redis
      - REDIS_PORT=6379
      # OSM OAuth
      - OSM_CLIENT_ID=${OSM_CLIENT_ID}
      - OSM_CLIENT_SECRET=${OSM_CLIENT_SECRET}
      # Email
      - EMAIL_HOST=mailhog
      - EMAIL_PORT=1025
      - EMAIL_USE_TLS=false
      # Overpass API
      - OVERPASS_API_URL=https://overpass-api.de/api/
      - RAW_DATA_API_URL=https://api-stage.raw-data.hotosm.org/
      # HDX (required for settings to load, use dummy key for dev)
      - HDX_API_KEY=dev-hdx-api-key
      - HDX_SITE=demo
      - SYNC_TO_HDX=false
      # Hanko SSO Authentication
      - AUTH_PROVIDER=${AUTH_PROVIDER:-hanko}
      - HANKO_API_URL=http://hanko:8000
      - HANKO_PUBLIC_URL=https://login.hotosm.test
      - JWT_ISSUER=https://login.hotosm.test
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - COOKIE_DOMAIN=.hotosm.test
      - COOKIE_SECURE=false
      - ADMIN_EMAILS=hernangigena@gmail.com,justina@animus.com.ar,andreatchirillano@hotmail.com,emilio.mariscal@hotosm.org
    command: python3 -m dramatiq tasks.task_runners -p 1
    networks:
      - hotosm
    depends_on:
      export-tool-db:
        condition: service_healthy
      export-tool-redis:
        condition: service_healthy
    restart: unless-stopped
