# HOTOSM Development Environment
# Orchestrates Portal, Drone-TM, and shared services using subdomain routing

name: hotosm-dev

networks:
  hotosm:
    name: hotosm-dev
    driver: bridge

volumes:
  portal-db-data:
  portal-hanko-db-data:
  dronetm-db-data:
  dronetm-minio-data:
  dronetm-redis-data:

services:
  # ==========================================
  # Traefik - Reverse Proxy (Subdomain Routing)
  # ==========================================
  traefik:
    image: traefik:v2.11
    container_name: hotosm-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
    ports:
      - "80:80"      # HTTP
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.localhost`)"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  # ==========================================
  # Portal - Authentication & SSO Portal
  # ==========================================

  # Portal Frontend (React + Vite)
  portal-frontend:
    build:
      context: ../portal/frontend
      dockerfile: Dockerfile
      target: dev
    container_name: hotosm-portal-frontend
    volumes:
      - ../portal/frontend/src:/app/src
      - ../portal/frontend/public:/app/public
      - ../portal/frontend/auth-libs:/app/auth-libs
    environment:
      - VITE_HANKO_URL=http://login.localhost
      - VITE_DRONE_TM_FRONTEND_URL=http://dronetm.localhost
      - VITE_DRONE_TM_API_URL=http://dronetm.localhost/api
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portal-frontend.rule=Host(`portal.localhost`)"
      - "traefik.http.services.portal-frontend.loadbalancer.server.port=5173"
    depends_on:
      - portal-backend

  # Portal Backend (FastAPI)
  portal-backend:
    build:
      context: ../portal/backend
      dockerfile: Dockerfile
      target: dev
    container_name: hotosm-portal-backend
    volumes:
      - ../portal/backend/app:/app/app
      - ../portal/backend/auth-libs:/app/auth-libs
    environment:
      - DATABASE_URL=postgresql+asyncpg://portal:portal@portal-db:5432/portal
      - HANKO_API_URL=http://hanko:8000
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - COOKIE_DOMAIN=.localhost
      - OSM_CLIENT_ID=${OSM_CLIENT_ID}
      - OSM_CLIENT_SECRET=${OSM_CLIENT_SECRET}
      - FRONTEND_URL=http://portal.localhost
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portal-backend.rule=Host(`portal.localhost`) && PathPrefix(`/api`)"
      - "traefik.http.services.portal-backend.loadbalancer.server.port=8000"
    depends_on:
      - portal-db
      - hanko

  # Portal Database
  portal-db:
    image: postgis/postgis:16-3.4
    container_name: hotosm-portal-db
    environment:
      - POSTGRES_USER=portal
      - POSTGRES_PASSWORD=portal
      - POSTGRES_DB=portal
    volumes:
      - portal-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U portal"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Hanko - Shared Authentication Service
  # ==========================================

  hanko:
    image: ghcr.io/teamhanko/hanko:latest
    container_name: hotosm-hanko
    environment:
      - DATABASE_URL=postgres://hanko:hanko@hanko-db:5432/hanko?sslmode=disable
      - COOKIE_SECRET=${COOKIE_SECRET:-change-me-in-production-min-32-chars}
      - COOKIE_DOMAIN=.localhost
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hanko.rule=Host(`login.localhost`)"
      - "traefik.http.services.hanko.loadbalancer.server.port=8000"
    depends_on:
      - hanko-db

  hanko-db:
    image: postgres:16-alpine
    container_name: hotosm-hanko-db
    environment:
      - POSTGRES_USER=hanko
      - POSTGRES_PASSWORD=hanko
      - POSTGRES_DB=hanko
    volumes:
      - portal-hanko-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hanko"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Drone-TM - Drone Tasking Manager
  # ==========================================

  # Drone-TM Frontend (React + Vite)
  dronetm-frontend:
    build:
      context: ../drone-tm/src/frontend
      dockerfile: prod.dockerfile
      target: dev
    container_name: hotosm-dronetm-frontend
    volumes:
      - ../drone-tm/src/frontend/src:/app/src
      - ../drone-tm/src/frontend/public:/app/public
      - ../drone-tm/src/frontend/auth-libs:/app/auth-libs
    environment:
      - VITE_AUTH_PROVIDER=hanko
      - VITE_HANKO_API_URL=http://login.localhost
      - VITE_PORTAL_SSO_URL=http://portal.localhost
      - VITE_FRONTEND_URL=http://dronetm.localhost
      - VITE_API_URL=http://dronetm.localhost/api
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dronetm-frontend.rule=Host(`dronetm.localhost`)"
      - "traefik.http.services.dronetm-frontend.loadbalancer.server.port=3040"
    depends_on:
      - dronetm-backend

  # Drone-TM Backend (FastAPI)
  dronetm-backend:
    build:
      context: ../drone-tm/src/backend
      dockerfile: prod.dockerfile
      target: dev
    container_name: hotosm-dronetm-backend
    volumes:
      - ../drone-tm/src/backend/app:/app/app
      - ../drone-tm/src/backend/auth-libs:/app/auth-libs
    environment:
      - DATABASE_URL=postgresql+asyncpg://dtm:dtm@dronetm-db:5432/dtm_db
      - HANKO_API_URL=http://hanko:8000
      - BACKEND_URL=http://dronetm.localhost
      - FRONTEND_URL=http://dronetm.localhost
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=dtm_user
      - S3_SECRET_KEY=somelongpassword
      - S3_BUCKET_NAME=dtm-bucket
      - REDIS_URL=redis://redis:6379
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dronetm-backend.rule=Host(`dronetm.localhost`) && PathPrefix(`/api`)"
      - "traefik.http.services.dronetm-backend.loadbalancer.server.port=8000"
    depends_on:
      - dronetm-db
      - minio
      - redis

  # Drone-TM Database
  dronetm-db:
    image: postgis/postgis:16-3.4-alpine
    container_name: hotosm-dronetm-db
    environment:
      - POSTGRES_USER=dtm
      - POSTGRES_PASSWORD=dtm
      - POSTGRES_DB=dtm_db
    volumes:
      - dronetm-db-data:/var/lib/postgresql/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dtm"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO - S3-compatible storage for drone imagery
  minio:
    image: minio/minio:latest
    container_name: hotosm-minio
    command: server /data --console-address ":9090"
    environment:
      - MINIO_ROOT_USER=dtm_user
      - MINIO_ROOT_PASSWORD=somelongpassword
    volumes:
      - dronetm-minio-data:/data
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      # MinIO Console
      - "traefik.http.routers.minio-console.rule=Host(`minio.localhost`)"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9090"
      # MinIO API (for S3 operations)
      - "traefik.http.routers.minio-api.rule=Host(`minio.localhost`) && PathPrefix(`/api`)"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"

  # Redis - Cache and task queue
  redis:
    image: redis:7-alpine
    container_name: hotosm-redis
    volumes:
      - dronetm-redis-data:/data
    networks:
      - hotosm
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NodeODM - Imagery processing
  nodeodm:
    image: opendronemap/nodeodm:latest
    container_name: hotosm-nodeodm
    environment:
      - NODE_OPTIONS=--max-old-space-size=8192
    networks:
      - hotosm
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nodeodm.rule=Host(`nodeodm.localhost`)"
      - "traefik.http.services.nodeodm.loadbalancer.server.port=3000"
